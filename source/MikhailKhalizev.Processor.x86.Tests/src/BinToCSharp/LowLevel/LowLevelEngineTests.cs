using System;
using FluentAssertions;
using MikhailKhalizev.Processor.x86.BinToCSharp.LowLevel;
using MikhailKhalizev.Processor.x86.BinToCSharp.MethodInfo;
using SharpDisasm;
using Xunit;

namespace MikhailKhalizev.Processor.x86.Tests.BinToCSharp.LowLevel
{
    public class LowLevelEngineTests
    {
        [Fact]
        public void DecodeMethodWithCallInsideInstruction()
        {
            // Перекодирование метода с "метка '*' делит инструкцию пополам".

            var mi = new MethodInfoDto();
            mi.Id = "0x545d-1c5d531f";
            mi.CsBase = 0x35f0;
            mi.Address = 0x545d;
            mi.Mode = ArchitectureMode.x86_16;
            mi.Raw = "e81600f024e81100e221e80c00b33fe80700743fe80200be395b2e8b0f8b1efa0a4343891efa0a8f07688f3eff2ef20affe18bdc5756368b7f04833e120a00755ce87300d1e89183c70f83e7f08bc7c1e8048b1e100a8cca2bda2bd803c2fc8706100a33f68ed88ec2f3a5161f53e8500059c1e1030e07b8cccc8bdff3ab83c30fc1eb04031eb609a1ec0c2bd8891e5a008ec0b44acd215e5f585c5dc3";

            var method = Decode(mi);
            method.End.Should().Be(0x5474);
        }

        [Fact]
        public void DecodeMethodWithCodeAfterJmp()
        {
            var mi = new MethodInfoDto();
            mi.Id = "0x18_a4be-dbd0b47";
            mi.CsBase = 0x18_9b20;
            mi.Address = 0x18_a4be;
            mi.Mode = ArchitectureMode.x86_16;
            mi.Raw = "a1140025080074d88b46108bc80bc97c0441a3700e89670e8e16280c8b26500f803e2e0000743583ec2a89670a061e166a18ff770a5153eaf21018008b1e96098e57028b670e8e46068b7f088b770aff7404b91500fcf3a559e352c3fe068211ff7706ff7708510e68110aff36260c68b247cb";

            var method = Decode(mi);

            method.MethodInfo.Id.Should().Be(mi.Id);
            method.End.Should().Be(mi.Address + mi.Raw.Length / 2);
            method.Instructions.Should().Contain(x => x.Begin == 0x18_a4fa)
                .Which.Should().BeOfType<CSharpInstruction>()
                .Which.CommentThis.Should().BeFalse();
        }

        [Fact]
        public void DecodeMethodIntersectsAlreadyDecoded()
        {
            var mi = new MethodInfoDto();
            mi.Id = "0x17_d8bb-9d77fc5";
            mi.CsBase = 0x17_4820;
            mi.Address = 0x17_d8bb;
            mi.Mode = ArchitectureMode.x86_16;
            mi.Raw = "7307e80e00b8ffff998be55dcb32e4e80100cba2591c0ae47522803e561c03720c3c22730c3c207204b005eb063c137602b013bb8c1cd798a34e1cc38ac4ebf700558bec8b5e063b1e5b1c7206b80009f9eb0bb43ecd217205c6875d1c00e98aff";

            var decodedMi = new MethodInfoDto();
            decodedMi.Id = "0x17_d8ce-57e40608";
            decodedMi.CsBase = 0x17_4820;
            decodedMi.Address = 0x17_d8ce;
            decodedMi.Mode = ArchitectureMode.x86_16;
            decodedMi.Raw = "a2591c0ae47522803e561c03720c3c22730c3c207204b005eb063c137602b013bb8c1cd798a34e1cc38ac4ebf7";

            var method = Decode(mi,
                engine =>
                {
                    engine.MethodInfoCollection.Add(decodedMi);
                    engine.AddAlreadyKnownMethod(decodedMi);
                });

            method.End.Should().Be(0x17_d8c8);
        }

        [Fact]
        public void DecodeMethodWithSkippedCode()
        {
            var mi = new MethodInfoDto();
            mi.Id = "0x19_6274-30babdc1";
            mi.CsBase = 0x19_5420;
            mi.Address = 0x19_6274;
            mi.Mode = ArchitectureMode.x86_16;
            mi.Raw = "c8e2000057561eb8a8008ed8c45e08268b4728268b572a8ac48ae28ad62af62ae48946fc8b5efc8a8756142ae48946fec45e0826ff77369a640f800083c4023d00007503e90900b80000baffffe90600b80000ba00008946ea8956ec8b46ec0b46ea7503e90900b8ffffbaffffe90600b8ffffba00008946a08956a28e06963f26803e8a30007503e91a0026c6068a3000c746fc4c00c45e0826c74728014c26c7472a00008b46088b560a1e8d7ea48bf016078edab91f00f3a51f8b5efc8a8756132ae4e99a148d46a41650ff7606e87bfe83c406e9cb14817ecc00ff7403e91e00837ec4787403e91500c746ccffffc746ce34478366defe8366e0ffe9a314803e8a0d007503e9af00807ecdff7403e9a600837ec4067403e92c008a46c4a271128366cc008366ceffa0721298990946cc0956ce8366defe8366e0ffc606721206e95e14e97100f646c5ff7403e968008a46c4a27212c646f5008a46c48846f4c646efffb800008946e88946e28d46e216508d46ee16501650ff1e861283c40c8366cc008366ceff8b46ee2bd20946cc0956ce803e7112007503e918008366cc008366ceffa0711298990946cc0956cec606711200e9ea13e90bfff646cc017503e90600e9fffee90300e900008b46ea8b56ec2346c42356c60bd07503e96d008b46a889469e8b46c48b56c689469a89569cff76c6ff76c4ff76a8900ee8271483c4068946988b46988946a82bc08946c68946c48d46a41650ff7606e82dfd83c406ff0e74128b46a83946987403e906008b469e8946a88b46c49903469a13569c8946c48956c6e95813e90300e976fe8b46ea8b56ec2346c42356c60bd07503e972008b46a8a394488b46c48b56c6a3904889169248c7069a480100ff369648ff76c6ff76c4ff76a8e8d31383c408a196488946a82bc08946c68946c48d46a41650ff7606e8a4fc83c4068b46a8390696487403e90600a194488946a88b46c49903069048131692488946c48956c6e9d012e915008b46a8390696487503e90600c7069a480000e9dcfd8a46cc2ae48946968b46a889469a8b46c48b56c6894692895694ff769a9a640f800083c4023d00007403e942008b469a390680127403e91500a17e122bd23b46927403e908003b56947503e921008b469a390684127403e91d00a182122bd23b46927403e910003b56947403e90800c746980100e90500c746980000837e98007403e90b008b4692894692c746940000837e96077503e90900837e96107403e96700837e96077403e93f009aa85180003d00007403e932008e06943fb83800268b16743b8946828956848b469ac45e82268947028b4692c45e822689078b4694c45e8226894706e91f00ff769aff7694ff7692ff76969af20a800083c408ff76969a0c0b800083c402837e98007403e9a9008d46a41650ff7696900ee80c2483c4063d00007503e90600e98b11e98b00ff7696900ee8ecfa83c4023d00007503e978008e06943f26833e723b007503e95c00ff76961e68f312e8aba983c406ff76a6ff7692ff769aff7696900ee862fa83c408ff769aff7694ff7692ff76969af20a800083c4088b4696c1e0030505008bd8b910008ec126c607866a01ff7696900ee86bf983c404e90d11e90d00ff76961e681513e84fa983c406c7469e00008b469a390678127403e91500a176122bd23b46927403e908003b56947503e921008b469a39067c127403e96700a17a122bd23b46927403e95a003b56947403e952006a00ff7696900ee804f983c404ff76969a4010800083c40250ff7696900ee83e1683c404837e96207203e91f008b4696050001509a4010800083c402508b469605000150900ee8161683c404ff469ee97100ff7694ff7692ff769aff76969ac10f800083c4088946903d00007503e91100ff7690ff7696900ee8e31583c404ff469e837e96207203e93800ff7694ff7692ff769a8b4696050001509ac10f800083c4088946903d00007503e91500ff76908b469605000150900ee8a21583c404ff469e837e9e007503e90300e9e70fff76969a4010800083c40250ff7696900ee87c1583c4048b469a89468a8b46928b56948946868956888d46861650ff76969a380b800083c4068946908a469804028b769083e6f88e06983f26c41e2201268800837e96207203e949008b4696050001509a4010800083c402508b469605000150900ee8181583c4048d46861650ff76969a530b800083c4068946908a469804028b769083e6f88e06983f26c41e2201268800837e98007403e91d00837e96007703e91400ff76a6ff7692ff769aff7696900ee839f883c408ff7696900ee8d1f783c40289468c89568e0bd07503e90d006a01ff7696900ee852f783c404e9f40e833e9a48007503e93900a194488946aa8b46a08b56a2f7d0f7d22346c02356c28b0e90488b1e9248234ea0235ea20bc10bd38946c08956c2c746fe0000e9b40ee90300e9d2f98b46ea8b56ec2346b42356b60bd07403e913008b46ea8b56ec2346b02356b20bd07503e9bb008b46a889468c8b46aa8946908b46b48b56b68946928956948b46b08b56b289469a89569cff76b6ff76b4ff76a8900ee8db0e83c406894682ff76b2ff76b0ff76aa900ee8c70e83c4068946868b46828946a88b46868946aa2bc08946b68946b42bc08946b28946b08d46a41650ff7606e8bff783c406832e7412028b46a83946827403e912008b468c8946a88b46928b56940146b41156b68b46aa3946867403e912008b46908946aa8b469a8b569c0146b01156b2e9d00de90300e9eef81e683a1368f603e8efa583c4068a46cc2ae4894686ff76da9a640f800083c4028946828e069a3f8b5e86268a8702002ae48bf0e916008bdec1e3038e06983f26c43e2201268a41012ae48bf083fe017503e924008bfec1e7038e06983f26c41e2201268a012ae42b46823d02007403e90300e90300e9beff83fe017403e92b00a17c128946aa837e82007503e90e00a17a1289468cc7468e0000e90b00a1761289468cc7468e0000e931008bdec1e3038e06983f26c43e2201268b41068946aa8bdec1e3038e06983f26c43e2201268b4102268b510489468c89568e837e82007503e91400c746fe00008b468c8b568e8946c08956c2e926008b46a08b56a2f7d0f7d22346c02356c28b4e8c8b5e8e234ea0235ea20bc10bd38946c08956c2e9a80c837ec4ff7403e91400837ec6ff7403e90b00c746fe0000e9b2f7e90300e9b3f88b46ea8b56ec2346c82356ca0bd07403e919008b46c88b56ca0346c41356c62346ea2356ec0bd07503e950018b46a88946828b46c48b56c689867aff89967cff8b46c88b56ca89469a89569c8b469a8b569c8946868956888b867aff8b967cff8946928956942bc089468089867eff8b46868946908a66fc2ac08946ccc746ce0000ff7694ff7692ff7682900ee87d0c83c40689468c8946a82bc08946c68946c4a198482bd23b56887603e934007303e908003b46867203e92700837e90007403e90500816e900002b806008b5e8ccd31035686134e8883f9107206a198488946908b46908946c8c746ca00008d46a41650ff7606e83af583c406ff0e7412f646de017503e90300e92d008b46902bd20146921156948b46902bd22946861956888b46cc2bd201867eff1156808b46880b46867403e937ff8b46828946a88b867aff8b967cff8946c48956c68b469a8b569c8946c88956caf646de017503e90300e9240b8b867eff8b56808946cc8956cec746fe0000e90f0be90300e92df68a46cc2ae489867aff83be7aff107203e90d008b9e7aff8a8766152ae48946fe83be7aff107203e914008b9e7aff80bf5615007503e90600e9f9f6e90300e9ecf5c7468200008b46c08b56c2d1e0d1d2d1e0d1d2d1e0d1d2d1e0d1d289867aff89967cff8b867cff0b867aff7403e90300e98200ff76da9a640f800083c4023d00007403e95000803e7112007403e90300e999f58b46c02bd2d1e0d1d2d1e0d1d2d1e0d1d2d1e0d1d25250900ee8030c83c4048946823d00007403e90300e935008366defe8366e0ff8b46828946ccc746ce0000e9320a83be7cff017603e912007303e90a0083be7aff007203e90300e93af5e90000c746cc0800c746ce00002bc08946c28946c0834ede01834ee000e9f609ff76da9a640f800083c4023d00007503e947008b46aa660f03c06689867aff83867aff0183967cff0083be7cff017603e912007303e90a0083be7aff007203e90300e9d5f4c746cc0900c746ce0000834ede01834ee000e99c09a190120b068e127403e90300e9b1f48b46aac1e8038bd8b950008ec126f607017403e90300e998f48b46aa2bc950519adc55800083c4045250ff1e8e1283c40489867eff83be7eff007f03e90300e96ff483be7eff007c03e91800834ede01834ee000c746cc0900c746ce0000e96100e92a008366defe8366e0ff8b46aa89867eff8b867effc1f8038bd8b950008ec126c60700b801008b9e7effcd318b46aac1e8038bd8b950008ec1268a079889867eff8b46aac1e8038bd8b950008ec126c607008346aa08f6867eff027403e93effc746aa0000e9c3088b46c08b56c2d1e0d1d2d1e0d1d2d1e0d1d2d1e0d1d289867aff89967cff8b46aa660f03c06689468283468201835684008b867cff0b867aff7403e90300e959028b46828b568439867aff7403e9140039967cff7403e90b008366defe8366e0ffe95f08ff76da9a640f800083c4023d00007403e90300e96df3b806008b5eaacd3172ba895686894e880bd174b0a194120b0692127503e900028d863cff1650ff1e921283c4048b46aa398672ff7403e934008b8640ff660f03c06689468283468201835684008b46828b568439967cff7303e911007603e9090039867aff7703e90300e9b3018b8664ff8b8e58ff898e38ff89863affc7468c0000e90300ff468c8b468c99c49e38ff263957027303e987017603e908002639077703e97a018b46868b56888b768c8bced1e603f1c1e602c49e38ff263940047403e95801263950067403e94f018b46aa398672ff7403e910008b46868b568889867eff895680e9b6008b768c8bc6d1e603f0c1e602c49e38ff268b400c268b500e89469a89569c5657b803058b9e7cff8b8e7aff8b769c8b7e9acd31897694897e925f5e7315c746cc0800c746ce00002bc08946c28946c0e9ee00895e80898e7eff8b867eff8b56808b768c8bced1e603f1c1e602c49e38ff26894004268950068b867aff8b967cff8b768c8bced1e603f1c1e602c49e38ff268940082689500a8b46928b56948b768c8bced1e603f1c1e602c49e38ff2689400c2689500eff7680ffb67effffb67cffffb67affff76aae86df083c40a8b46aa398640ff7403e956008b8672ff660f03c06689468283468201835684008b46828b568439967cff7603e91c007303e9090039867aff7203e90e008b867aff8b967cff894682895684ff7680ffb67effff7684ff7682ffb672ffe80bf083c40ae9c2fde965fec746cc0900c746ce0000834ede01834ee000e914066a00900ee88c8683c4026a006a24900ee859ee83c4048b46ea8b56ec2346c42356c60bd07403e913008b46ea8b56ec2346c02356c20bd07503e9c4018b46a889867eff8b46aa8946868b46c48b56c689469a89569c8b46c08b56c289468c89568eff76c6ff76c4ff76a8900ee82a0683c406898638ffff76c2ff76c0ff76aa900ee8150683c40689863cffc7867aff00008b863cffc7469200008946948d862aff898626ff8c9628ffc45e92268b4f04898e2aff83f9007503e96f00c45e9226ff770226ff37c45e9226ff7704900ee8c70583c40689862aff8b862affc746820000894684c45e828bb67aff268338007503e90700ff867affe9e9ff8d861eff1650ffb62aff9a824f800083c4068b867aff05020089861eff8d861eff1650ffb62aff9af44f800083c406c45e9226ff770826ff7706c45e9226ff770a900ee8570583c406c7862cff000089862effc78630ff96128c9e32ffc78634ff96128c9e36ff8b8638ff8946a82bc08946c68946c48b8628ff8946aa8b8626ff8946c0c746c200008d46a41650ff7606e82eee83c406c45e9226837f04011bc025ffff050400290674128b8638ff3946a87403e913008b867eff8946a88b469a8b569c0146c41156c68b46aa398628ff7403e912008b46868946aa8b468c8b568e0146c01156c26a00900ee8628483c4026a016a24900ee875ec83c404e91704e911008d46a41650ff7606e8b3ed83c406e9d3ffe90004900ee8aceab800008946aa8946a8e913ef8b46ea8b56ec2346c42356c60bd07403e913008b46ea8b56ec2346b02356b20bd07503e9cd008b46a889862aff8b46aa898638ff8b46c48b56c689863cff89963eff8b46b08b56b289867aff89967cffff76c6ff76c4ff76a8900ee8160483c40689861effff76b2ff76b0ff76aa900ee8010483c406898626ff8b861eff8946a88b8626ff8946aa2bc08946c68946c42bc08946b28946b08d46a41650ff7606e8f6ec83c406832e7412028b46a839861eff7403e915008b862aff8946a88b863cff8b963eff0146c41156c68b46aa398626ff7403e915008b8638ff8946aa8b867aff8b967cff0146b01156b2e9ff02e90300e91dee8b46ea8b56ec2346b42356b60bd07503e976008b46a889861eff8b46b48b56b6898626ff899628ffff76b6ff76b4ff76a8900ee8480383c40689862aff8b862aff8946a82bc08946b68946b48d46a41650ff7606e84cec83c406ff0e74128b862aff3946a87403e907008b861eff8946a88b46b499038626ff139628ff8946b48956b6e97302e90300e991ed807ecc067403e90800c746fe4000e980ed807ecc0a7403e90300e957ffe971ed8a46cc2ae4e91100e96deee946ffc746fe0200e96601e91c000bc07d03e91500487f03e9e2ff487503e9dfff487503e9dcffe90000e939ed8a46cc88861eff807ecd607403e90800c6861eff02e91c0080be1eff047403e90300e9f7fe80be1eff027403e90500c746fe020080be1eff027503e90a0080be1eff037403e9ee008b46ea8b56ec2346b42356b60bd07403e913008b46ea8b56ec2346b02356b20bd07503e9c8008b46a8898638ff8b46aa89863cff8b46b48b56b689867aff89967cff8b46b08b56b289867eff895680ff76b6ff76b4ff76a8900ee8f50183c406898626ffff76b2ff76b0ff76aa900ee8e00183c40689862aff8b8626ff8946a88b862aff8946aa2bc08946b68946b42bc08946b28946b08d46a41650ff7606e8d5ea83c406832e7412028b46a8398626ff7403e915008b8638ff8946a88b867aff8b967cff0146b41156b68b46aa39862aff7403e914008b863cff8946aa8b867eff8b56800146b01156b2e9df00e900ece90500c746fe4000e9f5eb8b46ea8b56ec2346b02356b20bd07503e976008b46aa898626ff8b46b08b56b289862aff89962cffff76b2ff76b0ff76aa900ee8200183c40689861eff8b861eff8946aa2bc08946b28946b08d46a41650ff7606e824ea83c406ff0e74128b46aa39861eff7403e907008b8626ff8946aa8b46b09903862aff13962cff8946b08956b2e94b00e90300e969ebe942003d18007603e93a00d1e0932effa7c5231b0f22101010a5103f11031549152d163a164f176f17ee182f19011a341be31df71f0820fe208a21aa21e2211b2326232c0f8b46ec0b46ea7503e91700f646de017503e90e008b46cc8946ccc746ce0000e947008b46ec0b46ea7503e93c008d46cc89861eff8c9620ff837efe007503e92800f646fe017503e91400c49e1eff268b07c49e1eff26890726c74702000083ae1eff04d16efee9cfff1e8d76a48cd08ed8c47e08b91f00f3a51fb80000e900001f5e5fc9cb";

            var method = Decode(mi);
            method.Instructions.Should().NotContain(x => x.Begin == 0x19_7414);
        }


        private DetectedMethod Decode(MethodInfoDto mi, Action<LowLevelEngine> configure = null) => LowLevelEngine.GetMethod(mi, configure);
    }
}